<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGNUL Protest Pulse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Adding a subtle animation for the counters */
        .counter-value {
            transition: all 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 antialiased">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 text-center border border-gray-700">

        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400 tracking-tight">RGNUL Protest Pulse</h1>
            <p class="text-gray-400 mt-2">Sentiment on campus protest action. Updates every few minutes.</p>
        </header>

        <main>
            <!-- Chart and Total Responses -->
            <div class="relative w-full max-w-xs mx-auto mb-6">
                <canvas id="protestChart"></canvas>
                <div id="totalResponses" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                    <span class="text-5xl font-extrabold text-white counter-value">0</span>
                    <span class="text-sm font-medium text-gray-400 tracking-wider uppercase">Total Responses</span>
                </div>
            </div>

            <!-- Legend/Counters -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div class="bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-lg font-medium text-gray-300">Protesting</p>
                    <p id="yesCount" class="text-4xl font-bold text-green-400 counter-value">0</p>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-lg font-medium text-gray-300">Not Protesting</p>
                    <p id="noCount" class="text-4xl font-bold text-red-400 counter-value">0</p>
                </div>
                <div class="bg-gray-700/50 p-4 rounded-lg">
                    <p class="text-lg font-medium text-gray-300">Undecided</p>
                    <p id="maybeCount" class="text-4xl font-bold text-yellow-400 counter-value">0</p>
                </div>
            </div>

            <!-- Status and Refresh Button -->
            <div class="mt-8 text-center">
                 <button id="refreshButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-400 disabled:bg-gray-600 disabled:cursor-not-allowed">
                    Refresh Now
                </button>
                <p id="statusText" class="text-gray-500 text-sm mt-3 h-5">Last updated: Never</p>
            </div>
        </main>
    </div>

    <script>
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6f3tvPm1QL0gmol7GgVcWX9Ks7tY5MOmRGFfoZRIt_vxue6A4-azF-3OVW76dr1B-xaELHYr-Iw-M/pub?gid=732343905&single=true&output=csv';
        const PROTEST_RESPONSE_COLUMN_INDEX = 1;
        // Set refresh interval to 60 seconds (1 minute)
        const REFRESH_INTERVAL_SECONDS = 60;

        const yesCountEl = document.getElementById('yesCount');
        const noCountEl = document.getElementById('noCount');
        const maybeCountEl = document.getElementById('maybeCount');
        const totalResponsesEl = document.getElementById('totalResponses').querySelector('span:first-child');
        const statusTextEl = document.getElementById('statusText');
        const refreshButton = document.getElementById('refreshButton');
        const ctx = document.getElementById('protestChart').getContext('2d');

        // Initialize the chart
        const protestChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, 0, 1], // Start with a placeholder gray color
                    backgroundColor: ['#4ade80', '#f87171', '#facc15'],
                    borderColor: '#1f2937', // Matches dark background
                    borderWidth: 4,
                }]
            },
            options: {
                responsive: true,
                cutout: '75%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });

        // Function to fetch and update data
        async function fetchDataAndUpdate() {
            statusTextEl.textContent = 'Fetching latest data...';
            refreshButton.disabled = true;

            try {
                // Add a cache-busting parameter to the URL to get the latest data
                const url = new URL(GOOGLE_SHEET_URL);
                url.searchParams.set('cache_bust', new Date().getTime());

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);

                // Assuming the first row is headers
                const responses = data.slice(1);
                
                let yes = 0, no = 0, maybe = 0;

                responses.forEach(row => {
                    if (row.length > PROTEST_RESPONSE_COLUMN_INDEX) {
                        const answer = row[PROTEST_RESPONSE_COLUMN_INDEX]?.trim();
                        // --- FIX: Updated the text to match your sheet's data ---
                        if (answer === "Yes, I'm in") yes++;
                        else if (answer === "No, I'm out") no++;
                        else if (answer === "I am undecided") maybe++;
                    }
                });

                updateUI(yes, no, maybe);

            } catch (error) {
                console.error("Failed to fetch or process sheet data:", error);
                statusTextEl.textContent = `Error: Could not load data.`;
                statusTextEl.classList.remove('text-gray-500');
                statusTextEl.classList.add('text-red-400');
            } finally {
                refreshButton.disabled = false;
            }
        }

        // Function to update the UI elements
        function updateUI(yes, no, maybe) {
            const total = yes + no + maybe;

            yesCountEl.textContent = yes;
            noCountEl.textContent = no;
            maybeCountEl.textContent = maybe;
            totalResponsesEl.textContent = total;

            protestChart.data.datasets[0].data = [yes, no, maybe];
            
            // If there's no data, show a gray placeholder chart
            if (total === 0) {
                 protestChart.data.datasets[0].backgroundColor = ['#4b5563']; // A neutral gray
                 protestChart.data.datasets[0].data = [1]; // To show a full circle
            } else {
                 protestChart.data.datasets[0].backgroundColor = ['#4ade80', '#f87171', '#facc15'];
            }
            
            protestChart.update();

            const now = new Date();
            statusTextEl.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            statusTextEl.classList.add('text-gray-500');
            statusTextEl.classList.remove('text-red-400');
        }

        // A robust CSV parser to handle quotes and newlines
        function parseCSV(str) {
            const arr = [];
            let quote = false;  // 'true' means we're inside a quoted field

            for (let row = 0, col = 0, c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';

                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
                if (cc == '"') { quote = !quote; continue; }
                if (cc == ',' && !quote) { ++col; continue; }
                if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
                if ((cc == '\n' || cc == '\r') && !quote) { ++row; col = 0; continue; }
                arr[row][col] += cc;
            }
            return arr;
        }


        // --- Event Listeners and Initial Load ---
        refreshButton.addEventListener('click', fetchDataAndUpdate);
        
        // Initial fetch when the page loads
        fetchDataAndUpdate();

        // Set an interval to auto-refresh the data
        setInterval(fetchDataAndUpdate, REFRESH_INTERVAL_SECONDS * 1000);
    </script>
</body>
</html>

